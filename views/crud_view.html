<!-- vusers.html -->
{{$session := .Session}}
{{$appid := .AppId}}
{{$portail := .Portail}}
{{$app := .Application}}
{{$theme := .Config.Theme}}
{{$tableid := .TableId}}
{{$viewid := .ViewId}}
{{$formid := .FormId}}
{{$table := .Table}}
{{$view := .View}}
{{$form := .FormView}}
{{$id := .Id}}
{{$tablekey := .Table.Key}}
{{$coldisplay := .ColDisplay}}
{{$elements := .Elements}}
{{$cols := .Cols}}
{{$composter := .Composter}}
<!DOCTYPE html>
<html>
{{template "_crud_head.html" .}}

<body>
  <!-- NAVBAR -->
  <div class="ui container">
    <div class="ui {{$theme}} inverted large fixed menu navbar">
      <a href="/crud" class="item" style="padding: 0.5em;">
        <i class="home icon"></i>
      </a>
      <div class="item">
        <a class="ui mini image" href="/crud/list/{{$appid}}/{{$tableid}}/{{$viewid}}/">
          <img class="ui mini image" src="{{$app.Image}}">
        </a>
      </div>
      <div class="header item">{{$form.Title}}: {{$coldisplay}}</div>
      <div class="right menu">
        {{if $view.Deletable}}
        <a class="ui icon item crud-jquery-delete" title="Supprimer la fiche...">
          <i class="trash icon"></i>
          {{end}}
        </a>
        {{if $form.Actions}}
        <div class="ui dropdown item">
          <i class="ellipsis vertical icon"></i>
          <div class="menu">
            {{range $iaction, $action := $form.Actions}}
            {{if not $action.Hide}}
            <a class="item crud-jquery-action" data-confirm="{{$action.WithConfirm}}"
              data-url="/crud/actionf/{{$appid}}/{{$tableid}}/{{$viewid}}/{{$id}}/{{$iaction}}">{{str2html $action.Label}}</a>
            {{end}}
            {{end}}
            <!-- end range actions-->
          </div>
        </div>
        {{end}}
        <!-- end if actions-->
      </div>
    </div>
  </div>
  <main>
    <div class="ui container">
      {{template "_crud_flash.html" .}}
      <!-- LIST CARD -->
      <div class="ui cards">
        {{ $isStart := true}}
        {{ range $irecord, $record := .Records }}
            <!-- pour mémoriser le hide dans une section -->
            {{ $isSectionHide := false}}

            {{ range $num, $key := $cols }}
            {{ $val := CrudIndex $record $key }}
            {{ $element := index $elements $key }}
            {{if and (eq $isSectionHide true) (eq $element.Hide false) (or (eq $element.Type "section") (eq $element.Type "image"))}}
              {{$isSectionHide = false}}<!-- les champs de la section seront affichés -->
            {{end}}
            {{if and (eq $element.Hide true) (or (eq $element.Type "section") (eq $element.Type "image"))}}
              {{$isSectionHide = true}}<!-- les champs de la section ne seront pas affichés -->
            {{end}}

            {{if and (eq $element.Hide false) (eq $isSectionHide false)}}
            <!-- 1ère section automatique si le 1er élement n'est pas une section-->
            {{if and $isStart (ne $element.Type "section")}}
            <a class="card raised crud-card-view" href="/crud/edit/{{$appid}}/{{$tableid}}/{{$viewid}}/{{$formid}}/{{$id}}">
              <div class="content">
              <div class="ui right floated">
                <i class="big {{$theme}} {{$view.IconName}} icon"></i>
              </div>
              <div class="header">
                <h4>{{$form.Title}}</h4>
              </div>
              {{ $isStart = false}}
            {{end}}
            <!-- Affichage de l'élément -->
            {{if (eq $element.Type "section")}}
            {{if not $isStart}}
            <!-- Fermeture de la card et ouverture d'une autre -->
          </div> <!-- end content card -->
        </a> <!-- end card -->
            {{end}}
            {{ $isStart = false}}
        <a class="card raised  crud-card-view"
          href="/crud/edit/{{$appid}}/{{$tableid}}/{{$viewid}}/{{$element.Params.Form}}/{{$id}}">
          <div class="content">
            <div class="ui right floated">
              <i class="big {{$theme}} {{$element.Params.IconName}} icon"></i>
            </div>
            <div class="header">
              <h4>{{$element.LabelLong}}</h4>
            </div>
            <!-- DEBUT type -->
            {{else if (eq $element.Type "action")}}
            {{if $element.Action.URL}}
            <button class="ui {{$theme}} button crud-jquery-url" data-url="{{$element.Action.URL}}">
              {{$element.LabelLong}}
            </button>
            {{else}}
            <button class="ui {{$theme}} button crud-jquery-action" data-confirm="{{$element.Action.WithConfirm}}" data-url="/crud/actione/{{$appid}}/{{$tableid}}/{{$viewid}}/{{$id}}/{{$key}}">
              {{$element.LabelLong}}
            </button>
            {{end}}
            {{else if (eq $element.Type "combo")}}
            <div class="description">
              <div class="meta">
                <span>{{$element.LabelLong}}</span>
              </div>
            </div>
            <div class="header">
              <h4>{{CrudItem $element.Items $val}} ({{$val}})</h4>
            </div>
            {{else if (eq $element.Type "checkbox")}}
            <div class="description">&nbsp;</div>
            <div class="header">
              <h4>
                {{if (eq $val "1") }}
                <i class="check square outline icon"></i> {{$element.LabelLong}}
                {{else}}
                <i class="square outline icon"></i> {{$element.LabelLong}}
                {{end}}
              </h4>
            </div>
            {{else if (eq $element.Type "image")}}
            {{$url := CrudMacro $element.Params.Path $record $session}}
            <!-- Fermeture de la card et ouverture d'une autre -->
          </div> <!-- end content card -->
        </a> <!-- end card -->
        <a class="card raised crud-card-view" href="{{$url}}?{{$composter}}">
          <div class="ui image">
            <img src="{{$url}}?{{$composter}}">
          </div>
          <div class="content">
            <div class="center aligned description"><b>{{$element.LabelLong}}</b></div>
            {{else if (eq $element.Type "password")}}
            <div class="description">
              <div class="meta">
                <span>{{$element.LabelLong}}</span>
              </div>
            </div>
            <div class="header">
              <h4>***</h4>
            </div>
            {{else if (eq $element.Type "tag")}}
            <div class="description">
              <div class="meta">
                <span>{{$element.LabelLong}}</span>
              </div>
            </div>
            {{$arr := CrudSplit $val ","}}
            {{range $i, $item := $arr}}
            <div class="ui small label">{{$item}}</div>
            {{end}}
            {{else if (eq $element.Type "textarea")}}
            <div class="description">
              <div class="meta">
                <span>{{$element.LabelLong}}</span>
              </div>
            </div>
            <div class="ui {{$element.Class}} message">
              {{$val}}
            </div>
            {{else}}
            <div class="description">
              <div class="meta">
                <span>{{$element.LabelLong}}</span>
              </div>
            </div>
            <div class="header">
              <span class="ui medium {{$element.Class}} text">
                {{if $element.Format}}
                {{CrudFormat $element.Format $val}}
                {{else}}
                {{$val}}
                {{end}}
              </span>
            </div>
            {{end}}
            <!-- end if type -->
            {{end}}
            <!-- end if Hide -->
            {{end}}
            <!-- end range $cols -->
          </div> <!-- end content card -->
        </a> <!-- end card -->
        {{end}}
        <!-- end range records -->
      </div>
    </div>
  </main>
  <!-- Demande de confirmation de la suppression -->
  <div class="ui modal">
    <div class="header">Suppression de {{$coldisplay}}</div>
    <div class="content">
      <p>Veuillez le confirmer</p>
    </div>
    <div class="actions">
      <div class="ui cancel button">Annuler</div>
      <div class="ui approve button">Je confirme</div>
    </div>
  </div>
  <form action="/crud/delete/{{$appid}}/{{$tableid}}/{{$viewid}}/{{$id}}" method="POST">
    {{ .xsrfdata }}
  </form>
  {{template "_crud_foot.html" .}}
</body>

</html>